# 15.通过共通设计提高一致性（3）

###### 批次类型 

批次可以分为几种不同的类型，因此我们需要定义这些分类，并在批次列表和架构的处理方式中使用它们。例如，可以考虑以下几种类型：

######  i）业务处理批次 

这是定期进行的，例如每天、每月等，用于切换系统状态的日更换处理、结算处理等，或更改数据状态的批次。

###### ii）汇总批次 

这是在指定的间隔，例如1天、1周、1个月、1个季度、半年、1年等，对业务数据进行汇总的批次。近年来，可能包括处理大数据，制作分析数据的批次。

###### ⅲ）协作批次 

这是为了与其他系统的数据协作而启动的批次。最近，也可能会考虑到协作间隔，选择间隔较短的批次或者采用非批次的方法。 

###### iv）基础设施类批次 

作为基础设施所需的处理，例如备份/数据删除（清除）等处理定期执行的批次。



###### 批次的处理粒度 

批次的粒度也是一个重要的点。从重用的单位、错误处理的单位等，可以定义出粒度细的处理，或者排列这些处理的批次（称为作业网络或作业流等）等不同的粒度，因此需要定义和描述这些粒度。这些粒度将在考虑处理方式或批次设计时用到。一般的粒度可以考虑以下几种：

###### 批次处理的粒度

| 粒度     | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| 作业步骤 | 一次处理的程序，不会被分割成多个程序的粒度。                 |
| 作业     | 一些作业步骤由多个程序处理。一旦执行，就会以错误或完成的形式存在，不会因等待等而暂停的粒度。 |
| 作业网络 | 组合作业和批次来处理的程序。即使被执行，也可能由于文件协作的等待等原因，不会一次性完成的粒度。 |



###### 重新运行（重新执行）方针 

任何处理都可能失败，批次处理也不例外。与逐个处理的项目不同，批次处理可能已经部分完成，因此需要注意这一点。为了保持数据的一致性或在预定时间内重新执行批次，确定下面将要说明的“重新运行方针”是很重要的。

![重新运行（重新执行）方针 ](https://github.com/RNCloudService/higher-process/blob/main/%E4%B8%8A%E6%B5%81%E5%B7%A5%E7%A8%8B%E8%AE%BE%E8%AE%A12/picture/27.jpg)



###### 批次处理时间段 

批次处理与数据更新有关，因此通常在在线服务停止期间进行。因此，有必要在有限的时间内进行处理，并确认可以处理的时间段，同时预计在该时间段内将要处理的数据量，并进行描述。

###### 错误处理方针 

需要假定任何粒度的批次都可能出现错误，并进行批次设计。因此，需要明确错误处理方针，特别是考虑使其可以重新运行。 以下三个是在错误处理时需要考虑的项目： 批次中需要考虑的错误处理项目：

1. 能够检测到错误的发生
2. 能够识别错误
3. 能够由错误引发的不一致性 对于这些处理方式，为了“1. 能够检测到错误的发生”，如果发生错误，则将错误输出到日志，并监视该日志。基于这个，操作负责人会查看输出到日志的内容，并考虑输出到消息或日志的内容，以便“2. 能够识别错误”。将错误检测用作触发器，进行人工操作或通过恢复程序进行自动恢复等，考虑“3. 能够解决由错误引发的不一致性”的策略。考虑使用这种策略来恢复一致性，并简化重新运行的设计。

###### 事务处理策略 

在批处理中，与在线处理不同，事务范围通常会更长。 这是因为事务处理（开始，提交处理）需要时间，因此通常会采取在更新了一定数量的数据后一次性提交的策略。 如果需要重新运行，则将从尚未提交的事务处理部分重新开始。或者，也可以使用保存点，回滚一部分然后重新运行。批处理的执行状态 批处理中的数据量大，因此需要一定的时间来处理。因此，需要掌握执行到哪一步的中间状态。 完成用作重新运行基准的处理点后，将更改状态，并管理该状态。这种状态管理通常是通过所谓的作业控制器来实现的，作业控制器是批处理执行基础设施

